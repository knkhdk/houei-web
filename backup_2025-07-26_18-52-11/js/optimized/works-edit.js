document.addEventListener('DOMContentLoaded',function(){loadWorkData();const form=document.getElementById('worksEditForm');if (form){form.addEventListener('submit',handleWorksEdit);}});function getWorkIdFromUrl(){const urlParams=new URLSearchParams(window.location.search);return urlParams.get('id');}function loadWorkData(){const workId=getWorkIdFromUrl();if (!workId){showMessage('施工実績IDが指定されていません。','error');setTimeout(()=>{window.location.href='index.html';},2000);return;}const works=JSON.parse(localStorage.getItem('works') || '[]');const work=works.find(w=> w.id===workId);if (!work){showMessage('指定された施工実績が見つかりません。','error');setTimeout(()=>{window.location.href='index.html';},2000);return;}populateForm(work);document.getElementById('loadingMessage').style.display='none';document.getElementById('worksEditForm').style.display='block';}function populateForm(work){document.getElementById('workId').value=work.id;document.getElementById('title').value=work.title;document.getElementById('category').value=work.category;document.getElementById('location').value=work.location;document.getElementById('description').value=work.description;document.getElementById('year').value=work.year;const currentImageDiv=document.getElementById('currentImage');currentImageDiv.innerHTML=` <p><strong>現在の画像:</strong></p> <img src="../images/${work.image}" alt="${work.title}" style="max-width: 200px;height: auto;border: 1px solid #ddd;border-radius: 4px;"> `;const details=work.details ||{};const detailKeys=Object.keys(details);for (let i=1;i <=4;i++){const keyInput=document.getElementById(`detail${i}_key`);const valueInput=document.getElementById(`detail${i}_value`);if (detailKeys[i-1]){keyInput.value=detailKeys[i-1];valueInput.value=details[detailKeys[i-1]];}else{keyInput.value='';valueInput.value='';}}}function handleWorksEdit(e){e.preventDefault();const formData=new FormData(e.target);const workId=formData.get('id');const updatedWorkData={id: workId,title: formData.get('title'),category: formData.get('category'),location: formData.get('location'),description: formData.get('description'),year: parseInt(formData.get('year')),image: formData.get('image') ? 'works/'+formData.get('image').name : getCurrentImagePath(workId),details:{},createdAt: getCurrentWorkData(workId).createdAt,updatedAt: new Date().toISOString()};for (let i=1;i <=4;i++){const key=formData.get(`detail${i}_key`);const value=formData.get(`detail${i}_value`);if (key && value){updatedWorkData.details[key]=value;}}let works=JSON.parse(localStorage.getItem('works') || '[]');const workIndex=works.findIndex(w=> w.id===workId);if (workIndex !==-1){works[workIndex]=updatedWorkData;localStorage.setItem('works',JSON.stringify(works));showMessage('施工実績が正常に更新されました。','success');setTimeout(()=>{window.location.href='index.html';},3000);}else{showMessage('施工実績の更新に失敗しました。','error');}}function getCurrentImagePath(workId){const work=getCurrentWorkData(workId);return work ? work.image : 'works/placeholder.jpg';}function getCurrentWorkData(workId){const works=JSON.parse(localStorage.getItem('works') || '[]');return works.find(w=> w.id===workId);}function deleteWork(){const workId=getWorkIdFromUrl();if (!workId){showMessage('施工実績IDが指定されていません。','error');return;}if (confirm('この施工実績を削除しますか？この操作は取り消せません。')){let works=JSON.parse(localStorage.getItem('works') || '[]');works=works.filter(w=> w.id !==workId);localStorage.setItem('works',JSON.stringify(works));showMessage('施工実績が正常に削除されました。','success');setTimeout(()=>{window.location.href='index.html';},3000);}}function previewWorkEdit(){const form=document.getElementById('worksEditForm');const formData=new FormData(form);const previewData={title: formData.get('title') || '工事名が入力されていません',category: formData.get('category') || 'カテゴリが選択されていません',location: formData.get('location') || '施工場所が入力されていません',description: formData.get('description') || '工事概要が入力されていません',year: formData.get('year') || '施工年が入力されていません',image: getCurrentImagePath(getWorkIdFromUrl()),details:{}};for (let i=1;i <=4;i++){const key=formData.get(`detail${i}_key`);const value=formData.get(`detail${i}_value`);if (key && value){previewData.details[key]=value;}}const previewHTML=generateWorksPreviewHTML(previewData);const previewContainer=document.getElementById('previewContainer');const previewContent=document.getElementById('previewContent');previewContent.innerHTML=previewHTML;previewContainer.style.display='block';previewContainer.scrollIntoView({behavior: 'smooth'});}function generateWorksPreviewHTML(data){let detailsHTML='';for (const [key,value] of Object.entries(data.details)){detailsHTML+=`<div class="detail-item"><strong>${key}:</strong> ${value}</div>`;}return ` <div class="works-card preview-card"> <div class="works-card-image"> <img src="../images/${data.image}" alt="${data.title}"> </div> <div class="works-card-content"> <div class="works-card-header"> <h3>${data.title}</h3> <span class="works-category">${data.category}</span> </div> <div class="works-card-info"> <p><strong>施工場所:</strong> ${data.location}</p> <p><strong>施工年:</strong> ${data.year}</p> </div> <div class="works-card-description"> <p>${data.description}</p> </div> ${detailsHTML ? `<div class="works-card-details">${detailsHTML}</div>` : ''}</div> </div> `;}function showMessage(message,type='info'){const existingMessage=document.querySelector('.message');if (existingMessage){existingMessage.remove();}const messageDiv=document.createElement('div');messageDiv.className=`message message-${type}`;messageDiv.textContent=message;messageDiv.style.cssText=` position: fixed;top: 20px;right: 20px;padding: 15px 20px;border-radius: 5px;color: white;font-weight: 500;z-index: 1000;max-width: 300px;box-shadow: 0 4px 12px rgba(0,0,0,0.15);`;if (type==='success'){messageDiv.style.backgroundColor='#4CAF50';}else if (type==='error'){messageDiv.style.backgroundColor='#f44336';}else{messageDiv.style.backgroundColor='#2196F3';}document.body.appendChild(messageDiv);setTimeout(()=>{if (messageDiv.parentNode){messageDiv.remove();}},3000);}